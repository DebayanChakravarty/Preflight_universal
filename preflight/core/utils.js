export function toGrayscale(img){const d=img.data,n=img.width*img.height;const out=new Uint8ClampedArray(n);for(let i=0,j=0;i<d.length;i+=4,j++){out[j]=(0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2])|0;}return out;}
export function stddev(a){let s=0,s2=0;for(let i=0;i<a.length;i++){const v=a[i];s+=v;s2+=v*v;}const n=a.length,mean=s/n;return Math.sqrt(Math.max(0,s2/n-mean*mean));}
export function laplacianVariance(g,w,h){const k=[-1,-1,-1,-1,8,-1,-1,-1,-1];let sum=0,sum2=0,count=0;for(let y=1;y<h-1;y++){for(let x=1;x<w-1;x++){let v=0,i=0;for(let dy=-1;dy<=1;dy++){for(let dx=-1;dx<=1;dx++){v+=g[(y+dy)*w+(x+dx)]*k[i++];}}sum+=v;sum2+=v*v;count++;}}const mean=sum/count;return Math.max(0,sum2/count-mean*mean)/100;}
export function detectDelimiter(sample){const candidates=[',',';','\t','|'];const score=c=>{const lines=sample.split(/\r?\n/).slice(0,50);const counts=lines.map(l=>l.split(c).length);const mean=counts.reduce((a,b)=>a+b,0)/counts.length;const varc=counts.reduce((a,b)=>a+(b-mean)*(b-mean),0)/counts.length;return -varc;};return candidates.sort((a,b)=>score(b)-score(a))[0];}
export function mode(arr){const m=new Map();arr.forEach(v=>m.set(v,(m.get(v)||0)+1));let best=arr[0],bestn=0;for(const [k,v] of m){if(v>bestn){best=k;bestn=v;}}return best;}
export function refCols(ref){const m=/:([A-Z]+)\d+$/i.exec(ref);if(!m)return 0;return colToNum(m[1]);}function colToNum(col){let n=0;for(let i=0;i<col.length;i++){n=n*26+(col.toUpperCase().charCodeAt(i)-64);}return n;}
export function loadImage(file){return new Promise((resolve,reject)=>{const url=URL.createObjectURL(file);const img=new Image();img.onload=()=>{URL.revokeObjectURL(url);resolve(img);};img.onerror=()=>reject(new Error('Failed to load image.'));img.src=url;});}
export function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
export function fmtSize(n){const u=['B','KB','MB','GB'];let i=0;while(n>1024&&i<u.length-1){n/=1024;i++}return `${n.toFixed(1)} ${u[i]}`;}